var node0=[-1e3,0,-1e3],node1=[-1e3,0,1e3],node2=[-1e3,600,-1e3],node3=[-1e3,600,1e3],node4=[1e3,0,-1e3],node5=[1e3,0,1e3],node6=[1e3,600,-1e3],node7=[1e3,600,1e3],node8=[10,50,-500],node9=[10,50,510],node10=[10,150,-500],node11=[10,150,510],node12=[-500,50,-500],node13=[-500,50,510],node14=[-500,150,-500],node15=[-500,150,510],nodes=[node0,node1,node2,node3,node4,node5,node6,node7,node8,node9,node10,node11,node12,node13,node14,node15],tri0=[4,0,2],tri1=[4,2,6],tri2=[7,4,6],tri3=[4,7,5],tri4=[5,7,1],tri5=[3,1,7],tri6=[0,4,1],tri7=[4,5,1],tri8=[0,3,2],tri9=[3,0,1],tri10=[7,6,3],tri11=[2,3,6],tri12=[12,8,10],tri13=[12,10,14],tri14=[15,12,14],tri15=[12,15,13],tri16=[13,15,9],tri17=[11,9,15],tri18=[8,12,9],tri19=[12,13,9],tri20=[8,11,10],tri21=[11,8,9],tri22=[15,14,11],tri23=[10,11,14],triangles=[tri0,tri1,tri2,tri3,tri4,tri5,tri6,tri7,tri8,tri9,tri10,tri11,tri12,tri13,tri14,tri15,tri16,tri17,tri18,tri19,tri20,tri21,tri22,tri23],room=[tri0,tri1,tri2,tri3,tri4,tri5,tri6,tri7,tri8,tri9,tri10,tri11],platform=[tri12,tri13,tri14,tri15,tri16,tri17,tri18,tri19,tri20,tri21,tri22,tri23],roomData={color:{r:210,g:210,b:210},collide:!1},platformData={color:{r:66,g:135,b:245},collide:!0},collided=!1,objects=[room,platform],objectData=[roomData,platformData],backgroundColor="white",nodeColor="red",edgeColor="black",nodeSize=5,width=900,height=600,focalLength=-1e3,camera=[500,400,500],rot=[0,0,0],lightVector=[0,-1,-2],pixelSize=4,pixelData=null;function round3(e){return Math.ceil(1e6*e)/1e6}function inverseMatrix(e){var t=round3(e[0][0]),a=round3(e[0][1]),i=round3(e[0][2]),r=round3(e[1][0]),l=round3(e[1][1]),o=round3(e[1][2]),n=round3(e[2][0]),p=round3(e[2][1]),x=round3(e[2][2]),D=l*x-o*p,d=i*p-a*x,c=a*o-i*l,m=o*n-r*x,h=t*x-i*n,v=i*r-t*o,u=r*p-l*n,s=a*n-t*p,w=t*l-a*r,f=round3(t*(l*x-o*p)-a*(r*x-o*n)+i*(r*p-l*n));return[[D/f,d/f,c/f],[m/f,h/f,v/f],[u/f,s/f,w/f]]}function multiplyMatrixVec(e,t){return[e[0][0]*t[0]+e[0][1]*t[1]+e[0][2]*t[2],e[1][0]*t[0]+e[1][1]*t[1]+e[1][2]*t[2],e[2][0]*t[0]+e[2][1]*t[1]+e[2][2]*t[2]]}Array.prototype.min=function(){return Math.min.apply(null,this)};var ctx,subtractVectors=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},normaliseVector=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return[e[0]/t,e[1]/t,e[2]/t]},equationOfAPlane=function(e){var t=nodes[e[0]],a=nodes[e[1]],i=nodes[e[2]],r=subtractVectors(t,a),l=subtractVectors(t,i),o=r[1]*l[2]-r[2]*l[1],n=r[2]*l[0]-r[0]*l[2],p=r[0]*l[1]-r[1]*l[0];return[o,n,p,-(o*t[0]+n*t[1]+p*t[2])]},dotProduct=function(e,t){return round3(e[0]*t[0]+e[1]*t[1]+e[2]*t[2])},movement={up:!1,down:!1,left:!1,right:!1,lookUp:!1,lookDown:!1,jump:!1};document.addEventListener("keydown",function(e){switch(e.keyCode){case 65:movement.left=!0;break;case 87:movement.up=!0;break;case 83:movement.down=!0;break;case 68:movement.right=!0;break;case 38:movement.lookUp=!0;break;case 40:movement.lookDown=!0}}),document.addEventListener("keyup",function(e){switch(e.keyCode){case 65:movement.left=!1;break;case 87:movement.up=!1;break;case 68:movement.right=!1;break;case 83:movement.down=!1;break;case 38:movement.lookUp=!1;break;case 40:movement.lookDown=!1;break;case 32:movement.jump=!0}}),lightVector=normaliseVector(lightVector),window.onload=(()=>{var e=document.getElementById("canvas");ctx=e.getContext("2d"),pixelData=new Uint8ClampedArray(height*width*4),setTimeout(()=>{ViewFrames()},1e3)});var velz=0,vely=0,velRotY=0,velRotX=0,velZConstant=.85,velYConstant=.9,velRotYConstant=.9,velRotXConstant=.85,totalRotX=.001,totalRotY=.001;function UpdatePlayerMovement(){camera[1]>250&&(vely-=3),movement.down?velz+=.5:movement.up&&(velz-=.5),movement.left?velRotY-=.005:movement.right&&(velRotY+=.005),movement.lookUp?velRotX+=.005:movement.lookDown&&(velRotX-=.005),movement.jump&&(250===camera[1]&&(vely+=23),movement.jump=!1),vely*=velYConstant,velz*=velZConstant,totalRotX+=velRotX*=velRotXConstant,totalRotY+=velRotY*=velRotYConstant,camera[2]+=velz,camera[1]+=vely,camera[1]<250&&(camera[1]=250)}function ViewFrames(){UpdatePlayerMovement(),draw(),collided&&(console.log("hit"),camera[2]-=velz,camera[1]-=vely,velz=0,vely=0),ctx.clearRect(0,0,width,height);let e=new ImageData(pixelData,width,height);ctx.putImageData(e,0,0),requestAnimationFrame(ViewFrames)}function calcIntersection(e,t,a,i,r){var l=r[0],o=r[1],n=r[2],p=r[3],x=camera[0],D=camera[1],d=camera[2],c=(l*x+o*D+n*d+p)/(l*x+o*D+n*d-l*e-o*t-n*a);return[(1-c)*x+c*e,(1-c)*D+c*t,(1-c)*d+c*a,c]}function checkIfInsideTriangle(e,t){var a=nodes[e[0]],i=nodes[e[1]],r=nodes[e[2]],l=[[a[0],i[0],r[0]],[a[1],i[1],r[1]],[a[2],i[2],r[2]]],o=[t[0],t[1],t[2]],n=multiplyMatrixVec(inverseMatrix(l),o);return!(n[0]<0||n[1]<0||n[2]<0)}function draw(){collided=!1;var e=width/pixelSize,t=height/pixelSize,a=Math.pow(1500,2);for(let y=0;y<t;y++)for(let t=0;t<e;t++){var i,r=1e13,l=!1;for(let e=0;e<objects.length;e++){const w=objects[e];var o=objectData[e];for(let e=0;e<w.length;e++){var n=pixelSize*t-camera[0]/2,p=pixelSize*y-camera[1]/2,x=camera[2]+focalLength,D=rotateX3D(totalRotX,[n,p,x]);D=rotateY3D(totalRotY,D);var d=w[e],c=equationOfAPlane(d),m=calcIntersection(D[0],D[1],D[2],d,c);if(!Number.isNaN(m[0])&&m[0]!==1/0&&m[0]!==-1/0)if(!Number.isNaN(m[1])&&m[1]!==1/0&&m[1]!==-1/0)if(!Number.isNaN(m[2])&&m[2]!==1/0&&m[2]!==-1/0)if(checkIfInsideTriangle(d,m)&&m[3]>0){var h=a/(12.56*(Math.pow(m[0]-camera[0],2)+Math.pow(m[1]-camera[1],2)+Math.pow(m[2]-camera[2],2))),v=normaliseVector(c.slice(0,3)),u=(1*(Math.abs(180*dotProduct(v,lightVector))/180)+29*h)/30,s=[o.color.r*u,o.color.g*u,o.color.b*u];Math.abs(r)>Math.abs(m[3])&&(i=s,r=Math.abs(m[3]),l=!0)}}}if(l){var w=i[0],f=i[1],b=i[2],g=0;pixelData[(g=4*((k=y*pixelSize)*width+(M=t*pixelSize)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*(k*width+(M+1)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*(k*width+(M+2)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*(k*width+(M+3)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+1)*width+M))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+1)*width+(M+1)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+1)*width+(M+2)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+1)*width+(M+3)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+2)*width+M))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+2)*width+(M+1)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+2)*width+(M+2)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+2)*width+(M+3)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+3)*width+M))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+3)*width+(M+1)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+3)*width+(M+2)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[(g=4*((k+3)*width+(M+3)))+0]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255}else{var k,M;w=255,f=255,b=255,g=0;pixelData[g=4*((k=y*pixelSize)*width+(M=t*pixelSize))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*(k*width+(M+1))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*(k*width+(M+2))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*(k*width+(M+3))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+1)*width+M)]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+1)*width+(M+1))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+1)*width+(M+2))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+1)*width+(M+3))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+2)*width+M)]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+2)*width+(M+1))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+2)*width+(M+2))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+2)*width+(M+3))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+3)*width+M)]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+3)*width+(M+1))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+3)*width+(M+2))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255,pixelData[g=4*((k+3)*width+(M+3))]=w,pixelData[g+1]=f,pixelData[g+2]=b,pixelData[g+3]=255}}}var rotateZ3D=function(e,t){var a=t,i=Math.sin(e),r=Math.cos(e),l=t[0]-camera[0],o=t[1]-camera[1];return a[0]=round3(l*r-o*i+camera[0]),a[1]=round3(o*r+l*i+camera[1]),a},rotateX3D=function(e,t){var a=t,i=Math.sin(e),r=Math.cos(e),l=t[1]-camera[1],o=t[2]-camera[2];return a[1]=round3(l*r-o*i+camera[1]),a[2]=round3(o*r+l*i+camera[2]),a},rotateY3D=function(e,t){var a=t,i=Math.sin(e),r=Math.cos(e),l=t[0]-camera[0],o=t[2]-camera[2];return a[0]=round3(l*r+o*i+camera[0]),a[2]=round3(o*r-l*i+camera[2]),a};