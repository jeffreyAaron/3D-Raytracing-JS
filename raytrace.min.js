var node0=[-1e3,0,-1e3],node1=[-1e3,0,1e3],node2=[-1e3,600,-1e3],node3=[-1e3,600,1e3],node4=[1e3,0,-1e3],node5=[1e3,0,1e3],node6=[1e3,600,-1e3],node7=[1e3,600,1e3],nodes=[node0,node1,node2,node3,node4,node5,node6,node7],tri0=[4,0,2],tri1=[4,2,6],tri2=[7,4,6],tri3=[4,7,5],tri4=[5,7,1],tri5=[3,1,7],tri6=[0,4,1],tri7=[4,5,1],tri8=[0,3,2],tri9=[3,0,1],tri10=[7,6,3],tri11=[2,3,6],triangles=[tri0,tri1,tri2,tri3,tri4,tri5,tri6,tri7,tri8,tri9,tri10,tri11],backgroundColor="white",nodeColor="red",edgeColor="black",nodeSize=5,width=900,height=600,focalLength=1e3,camera=[500,400,500],rot=[0,0,0],lightVector=[0,-1,-2],pixelSize=4,pixelData=null;function round3(e){return Math.ceil(1e6*e)/1e6}function inverseMatrix(e){var t=round3(e[0][0]),a=round3(e[0][1]),o=round3(e[0][2]),r=round3(e[1][0]),n=round3(e[1][1]),i=round3(e[1][2]),l=round3(e[2][0]),c=round3(e[2][1]),m=round3(e[2][2]),d=n*m-i*c,u=o*c-a*m,s=a*i-o*n,v=i*l-r*m,h=t*m-o*l,p=o*r-t*i,f=r*c-n*l,x=a*l-t*c,g=t*n-a*r,w=round3(t*(n*m-i*c)-a*(r*m-i*l)+o*(r*c-n*l));return[[d/w,u/w,s/w],[v/w,h/w,p/w],[f/w,x/w,g/w]]}function multiplyMatrixVec(e,t){return[e[0][0]*t[0]+e[0][1]*t[1]+e[0][2]*t[2],e[1][0]*t[0]+e[1][1]*t[1]+e[1][2]*t[2],e[2][0]*t[0]+e[2][1]*t[1]+e[2][2]*t[2]]}Array.prototype.min=function(){return Math.min.apply(null,this)};var ctx,subtractVectors=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},normaliseVector=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return[e[0]/t,e[1]/t,e[2]/t]},equationOfAPlane=function(e){var t=nodes[e[0]],a=nodes[e[1]],o=nodes[e[2]],r=subtractVectors(t,a),n=subtractVectors(t,o),i=r[1]*n[2]-r[2]*n[1],l=r[2]*n[0]-r[0]*n[2],c=r[0]*n[1]-r[1]*n[0];return[i,l,c,-(i*t[0]+l*t[1]+c*t[2])]},dotProduct=function(e,t){return round3(e[0]*t[0]+e[1]*t[1]+e[2]*t[2])},movement={up:!1,down:!1,left:!1,right:!1,lookUp:!1,lookDown:!1,jump:!1};document.addEventListener("keydown",function(e){switch(e.keyCode){case 65:movement.left=!0;break;case 87:movement.up=!0;break;case 83:movement.down=!0;break;case 68:movement.right=!0;break;case 38:movement.lookUp=!0;break;case 40:movement.lookDown=!0}}),document.addEventListener("keyup",function(e){switch(e.keyCode){case 65:movement.left=!1;break;case 87:movement.up=!1;break;case 68:movement.right=!1;break;case 83:movement.down=!1;break;case 38:movement.lookUp=!1;break;case 40:movement.lookDown=!1;break;case 32:movement.jump=!0}}),lightVector=normaliseVector(lightVector),window.onload=(()=>{var e=document.getElementById("canvas");ctx=e.getContext("2d"),pixelData=new Uint8ClampedArray(height*width*4),setTimeout(()=>{ViewFrames()},1e3)});var velz=0,vely=0,velRotY=0,velRotX=0,velZConstant=.85,velYConstant=.9,velRotYConstant=.9,velRotXConstant=.85,totalRotX=.001;function UpdatePlayerMovement(){camera[1]>250&&(vely-=3),movement.down?velz+=.5:movement.up&&(velz-=.5),movement.left?velRotY+=.005:movement.right&&(velRotY-=.005),movement.lookUp?velRotX-=.005:movement.lookDown&&(velRotX+=.005),movement.jump&&(250===camera[1]&&(vely+=23),movement.jump=!1),vely*=velYConstant,velRotY*=velRotYConstant,velz*=velZConstant,rotateX3D(-(totalRotX+=velRotX*=velRotXConstant)),rotateY3D(velRotY),rotateX3D(totalRotX+velRotX),camera[2]+=velz,camera[1]+=vely,camera[1]<250&&(camera[1]=250)}function ViewFrames(){UpdatePlayerMovement(),draw(),ctx.clearRect(0,0,width,height);let e=new ImageData(pixelData,width,height);ctx.putImageData(e,0,0),requestAnimationFrame(ViewFrames)}function RenderFrames(e){if(e>0){ctx.fillStyle="white",ctx.fillRect(0,0,width,height),rotateY3D(.01),draw(ctx,backgroundColor);let a=new ImageData(pixelData,width,height);ctx.putImageData(a,0,0);var t="FastFrames"+e+".png";document.getElementById("canvas").toBlob(function(e){saveAs(e,t)}),setTimeout(()=>{RenderFrames(e-1)},1)}}function calcIntersection(e,t,a,o,r){var n=r[0],i=r[1],l=r[2],c=r[3],m=camera[0],d=camera[1],u=camera[2],s=(n*m+i*d+l*u+c)/(n*m+i*d+l*u-n*e-i*t-l*a);return[(1-s)*m+s*e,(1-s)*d+s*t,(1-s)*u+s*a,s]}function checkIfInsideTriangle(e,t){var a=nodes[e[0]],o=nodes[e[1]],r=nodes[e[2]],n=[[a[0],o[0],r[0]],[a[1],o[1],r[1]],[a[2],o[2],r[2]]],i=[t[0],t[1],t[2]],l=multiplyMatrixVec(inverseMatrix(n),i);return!(l[0]<0||l[1]<0||l[2]<0)}function draw(){var e=width/pixelSize,t=height/pixelSize,a=Math.pow(1500,2);for(let D=0;D<t;D++)for(let t=0;t<e;t++){var o=[],r=[],n=!1;for(let e=0;e<triangles.length;e++){var i=pixelSize*t-camera[0]/2,l=pixelSize*D-camera[1]/2,c=focalLength,m=triangles[e],d=equationOfAPlane(m),u=calcIntersection(i,l,c,m,d);if(!Number.isNaN(u[0])&&u[0]!==1/0&&u[0]!==-1/0)if(!Number.isNaN(u[1])&&u[1]!==1/0&&u[1]!==-1/0)if(!Number.isNaN(u[2])&&u[2]!==1/0&&u[2]!==-1/0)if(checkIfInsideTriangle(m,u)){var s=a/(12.56*(Math.pow(u[0]-camera[0],2)+Math.pow(u[1]-camera[1],2)+Math.pow(u[2]-camera[2],2))),v=normaliseVector(d.slice(0,3)),h=Math.abs(180*dotProduct(v,lightVector)),p=(1*(h/180)+29*s)/30;r.push(p),o.push(u[3]),n=!0}}if(n){var f=o.min(),x=210*(s=r[o.indexOf(f)]),g=210*s,w=210*s;for(let e=0;e<pixelSize;e++)for(let a=0;a<pixelSize;a++){pixelData[(k=4*((D*pixelSize+e)*width+(t*pixelSize+a)))+0]=Math.round(x),pixelData[k+1]=Math.round(g),pixelData[k+2]=Math.round(w),pixelData[k+3]=255}}else for(let e=0;e<pixelSize;e++)for(let a=0;a<pixelSize;a++){var k;pixelData[(k=4*((D*pixelSize+e)*width+(t*pixelSize+a)))+0]=255,pixelData[k+1]=255,pixelData[k+2]=255,pixelData[k+3]=255}}}var rotateZ3D=function(e){for(var t=Math.sin(e),a=Math.cos(e),o=0;o<nodes.length;o++){var r=nodes[o],n=r[0]-camera[0],i=r[1]-camera[1];r[0]=round3(n*a-i*t+camera[0]),r[1]=round3(i*a+n*t+camera[1])}},rotateX3D=function(e){for(var t=Math.sin(e),a=Math.cos(e),o=0;o<nodes.length;o++){var r=nodes[o],n=r[1]-camera[1],i=r[2]-camera[2];r[1]=round3(n*a-i*t+camera[1]),r[2]=round3(i*a+n*t+camera[2])}},rotateY3D=function(e){for(var t=Math.sin(e),a=Math.cos(e),o=0;o<nodes.length;o++){var r=nodes[o],n=r[0]-camera[0],i=r[2]-camera[2];r[0]=round3(n*a+i*t+camera[0]),r[2]=round3(i*a-n*t+camera[2])}};